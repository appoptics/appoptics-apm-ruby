name: RELEASE Ruby Gem to RubyGems

on: [push]
#on:
#  workflow_dispatch:
#    inputs:
#      oboe_version:
#        description: 'Oboe version to use with this gem version'
#        required: true
#        default: 0.0.0

jobs:
  build:
    name: Build + Release Gem to RubyGems
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Set up Ruby 2.6 and bundle
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.6

      - name: Install gems
        run: |
          echo 'gem: --no-document' >> ~/.gemrc
          bundle install --without development --without test

      - name: Install swig 4.0.2
        run: |
          curl -SL http://kent.dl.sourceforge.net/project/swig/swig/swig-4.0.2/swig-4.0.2.tar.gz | tar xzC /tmp
          cd /tmp/swig-4.0.2
          ./configure && make && sudo make install
          cd -

      - name: Download oboe files from github, compile swig wrapper
        env:
          OBOE_TOKEN: ${{ secrets.OBOE_TOKEN }}
        run: |
          oboe_version=`cat ext/oboe_metal/src/VERSION`
#          bundle exec rake oboe_github_fetch[$oboe_version]
#          ls -l ext/oboe_metal/src
# TODO work on the above once I have access to secret server

      - name: Download files from files.appoptics.aom
        run: |
          oboe_version=`cat ext/oboe_metal/src/VERSION`
          bundle exec rake oboe_files_appoptics_fetch[$oboe_version]
          bundle exec rake oboe_verify

#      - name: Verify downloaded files against production
#        run: bundle exec rake verify_oboe_files

#      - name: Build Gem
#        run:  |
#          gem build appoptics_apm.gemspec
#          echo `shasum -a256 *.gem`
#          echo "::set-output name=GEM_VERSION::`ruby -e 'require "./lib/appoptics_apm/version"; puts AppOpticsAPM::Version::STRING'`"

# - name: Add checksum to tag for gem release and publish tag

# - name: push to rubygems and check checksum


#      - name: Test install
#        TODO test if gem installs

