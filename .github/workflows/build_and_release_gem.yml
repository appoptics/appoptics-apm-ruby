name: RELEASE Ruby Gem to RubyGems

on: [push]
#on:
#  workflow_dispatch:
#    inputs:
#      oboe_version:
#        description: 'Oboe version to use with this gem version'
#        required: true
#        default: 0.0.0

jobs:
  build:
    name: Build + Release Gem to RubyGems
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Set up Ruby 2.6 and bundle
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.6

      - name: Install gems
        run: |
          echo 'gem: --no-document' >> ~/.gemrc
          bundle install --without development --without test

      - name: Install swig 4.0.2
        run: |
          curl -SL http://kent.dl.sourceforge.net/project/swig/swig/swig-4.0.2/swig-4.0.2.tar.gz | tar xzC /tmp
          cd /tmp/swig-4.0.2
          ./configure && make && sudo make install
          cd -

      - name: Download oboe files from github, compile swig wrapper
        env:
          TRACE_QA_USER_TOKEN: ${{ secrets.TRACE_QA_USER_TOKEN }}
        run: |
          oboe_version=`cat ext/oboe_metal/src/VERSION`
          bundle exec rake oboe_github_fetch[$oboe_version]
          ls -l ext/oboe_metal/verify
          ls -l ext/oboe_metal/verify/bson

      - name: Download files from files.appoptics.com and github, and verify
        run: |
          oboe_version=`cat ext/oboe_metal/src/VERSION`
          bundle exec rake oboe_files_appoptics_fetch[$oboe_version]
          bundle exec rake oboe_verify

      - name: Build Gem, create release tag, upload to Rubygems, compare checksums
        id: build
        run:  |
          gem build appoptics_apm.gemspec
          checksum=`shasum -a256 *.gem | awk '{print $1;}'`
          echo "checksum: $checksum"
          echo ::set-output name=checksum::$checksum
          echo ::set-output name=gem_version::`ruby -e 'require "./lib/appoptics_apm/version"; puts AppOpticsAPM::Version::STRING'`
# push gem to rubygems.org

      - name:  echo gem release and checksum
# https://docs.github.com/en/rest/reference/repos#create-a-release
        run: |
          echo "checksum: ${{ steps.build.outputs.checksum }}"
          echo "gem version: ${{ steps.build.outputs.gem_version }}"

      - name: Create release
        uses: actions/github-script@v3
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.repos.createRelease({
              owner: "appoptics",
              repo: "appoptics-apm-ruby",
              body: "SHA256 checksum: ${{ steps.build.outputs.checksum }}",
              tag_name: "${{ steps.build.outputs.gem_version }}",
              name: "${{ steps.build.outputs.gem_version }}",
              draft: true
            })

      - name: get checksum from Rubygems
        id: checksum
        run: |
          gem_version=${{ steps.build.outputs.gem_version }}
          gem_version=4.8.4
          echo ::set-output name=geminfo::`curl https://rubygems.org/api/v2/rubygems/appoptics_apm/versions/$gem_version.json`

      - name: print checksums
        run: |
          echo "local checksum:    ${{ steps.build.outputs.checksum }}"
          echo "Rubygems checksum: ${{ fromJson(steps.checksum.outputs.geminfo).sha }}"

      - name: verify checksum
        if: fromJson(steps.checksum.outputs.geminfo).sha != steps.build.outputs.checksum
        run: |
          echo "local and rubygems checksum not matching
          exit 1


#      - name: Test install
#        TODO test if gem installs

